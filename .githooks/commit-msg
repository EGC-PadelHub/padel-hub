#!/bin/bash
# Git hook para validar mensajes de commit y merge

commit_msg_file=$1
commit_msg=$(cat "$commit_msg_file")

# Detectar si es un merge (m√©todo robusto)
is_merge=false
if git rev-parse --verify -q MERGE_HEAD > /dev/null 2>&1; then
    is_merge=true
elif grep -q "^Merge branch" "$commit_msg_file"; then
    is_merge=true
fi

# Patr√≥n b√°sico: debe empezar con feat: o fix:
pattern="^(feat|fix): .+"

if ! echo "$commit_msg" | grep -qE "$pattern"; then
    echo "‚ùå ERROR: El mensaje no sigue el formato correcto."
    echo ""
    if [ "$is_merge" = true ]; then
        echo "Los merges DEBEN tener mensaje personalizado con formato:"
        echo "  feat: descripci√≥n #n√∫mero"
        echo "  fix: descripci√≥n. Closes #n√∫mero"
    else
        echo "Formato requerido para commits:"
        echo "  feat: t√≠tulo"
        echo "  fix: t√≠tulo"
    fi
    echo ""
    echo "Ejemplos v√°lidos:"
    if [ "$is_merge" = true ]; then
        echo "  git merge bugfix -m \"fix: integra correcci√≥n de login #45\""
        echo "  git merge feature/nombre -m \"feat: integra notificaciones. Closes #46\""
    else
        echo "  feat: a√±ade sistema de notificaciones"
        echo "  fix: corrige error de login"
    fi
    echo ""
    echo "Tu mensaje:"
    echo "  $commit_msg"
    echo ""
    exit 1
fi

# VALIDACI√ìN: Commits deben tener t√≠tulo + descripci√≥n (m√≠nimo 3 l√≠neas no vac√≠as)
if [ "$is_merge" = false ]; then
    # Contar l√≠neas no vac√≠as y no comentadas
    non_empty_lines=$(echo "$commit_msg" | grep -v "^#" | grep -v "^$" | wc -l)
    
    if [ "$non_empty_lines" -lt 2 ]; then
        echo "‚ùå ERROR: El commit debe tener t√≠tulo Y descripci√≥n."
        echo ""
        echo "Formato requerido:"
        echo "  L√≠nea 1: feat: t√≠tulo (m√°x 50 caracteres)"
        echo "  L√≠nea 2: (vac√≠a)"
        echo "  L√≠nea 3+: descripci√≥n detallada"
        echo ""
        echo "Ejemplo:"
        echo "  feat: a√±ade sistema de notificaciones"
        echo ""
        echo "  Se implementa porque los usuarios necesitan saber"
        echo "  cuando hay nuevas actualizaciones en sus datasets."
        echo ""
        echo "üí° Usa 'git commit' (sin -m) para abrir el editor con la plantilla."
        echo ""
        exit 1
    fi
    
    # Validar que haya una l√≠nea en blanco despu√©s del t√≠tulo
    second_line=$(echo "$commit_msg" | sed -n '2p')
    if [ -n "$second_line" ] && ! echo "$second_line" | grep -q "^#"; then
        echo "‚ùå ERROR: Debe haber una l√≠nea en blanco despu√©s del t√≠tulo."
        echo ""
        echo "Formato correcto:"
        echo "  feat: t√≠tulo"
        echo "  <--- l√≠nea en blanco"
        echo "  Descripci√≥n detallada..."
        echo ""
        exit 1
    fi
fi

# VALIDACI√ìN PARA MERGES: deben tener #n√∫mero
if [ "$is_merge" = true ]; then
    # Obtener la rama actual
    current_branch=$(git rev-parse --abbrev-ref HEAD)
    
    # Si estamos en main, es obligatorio usar Closes
    if [ "$current_branch" = "main" ]; then
        if ! echo "$commit_msg" | grep -qiE "(close|fix|resolve)(s|d)? #[0-9]+"; then
            echo "‚ùå ERROR: Los merges a MAIN deben incluir 'Closes #n√∫mero'."
            echo ""
            echo "Est√°s en la rama 'main', por lo que este merge cerrar√° la issue."
            echo "Debes indicarlo expl√≠citamente con 'Closes #n√∫mero'."
            echo ""
            echo "Formato requerido:"
            echo "  feat: descripci√≥n. Closes #n√∫mero"
            echo "  fix: descripci√≥n. Closes #n√∫mero"
            echo ""
            echo "Ejemplos:"
            echo "  git merge trunk -m \"feat: release notificaciones. Closes #46\""
            echo "  git merge bugfix -m \"fix: release correcci√≥n. Closes #45\""
            echo ""
            echo "Tu mensaje:"
            echo "  $commit_msg"
            echo ""
            exit 1
        fi
    else
        # Para otras ramas (trunk, bugfix, etc.), solo requiere #n√∫mero
        if ! echo "$commit_msg" | grep -qE "#[0-9]+"; then
            echo "‚ùå ERROR: Los merges deben incluir #n√∫mero de la issue."
            echo ""
            echo "Formato requerido:"
            echo "  feat: descripci√≥n #n√∫mero"
            echo "  fix: descripci√≥n #n√∫mero"
            echo ""
            echo "Ejemplos:"
            echo "  git merge bugfix -m \"fix: integra correcci√≥n #45\""
            echo "  git merge feature/nombre -m \"feat: integra notificaciones #46\""
            echo ""
            echo "üí° NO uses 'Closes' aqu√≠ porque este merge no llegar√° a 'main' todav√≠a."
            echo ""
            echo "Tu mensaje:"
            echo "  $commit_msg"
            echo ""
            exit 1
        fi
        
        # Advertir si usan Closes en ramas que no son main
        if echo "$commit_msg" | grep -qiE "(close|fix|resolve)(s|d)? #[0-9]+"; then
            echo "‚ö†Ô∏è  ADVERTENCIA: Usaste 'Closes' en la rama '$current_branch'."
            echo ""
            echo "La issue NO se cerrar√° autom√°ticamente porque no est√°s en 'main'."
            echo "Solo se cierra cuando el commit llegue a la rama 'main'."
            echo ""
            echo "üí° Recomendaci√≥n: Usa 'Closes' solo en merges a 'main'."
            echo ""
            echo "¬øContinuar de todas formas? (Ctrl+C para cancelar)"
            read -t 5 || true
        fi
    fi
fi

# VALIDACI√ìN PARA COMMITS: NO deben tener #n√∫mero ni Closes
if [ "$is_merge" = false ]; then
    # Filtrar solo l√≠neas que NO son comentarios
    commit_msg_no_comments=$(echo "$commit_msg" | grep -v "^#")
    
    if echo "$commit_msg_no_comments" | grep -qE "#[0-9]+"; then
        echo "‚ùå ERROR: Los commits NO deben incluir #n√∫mero."
        echo ""
        echo "El #n√∫mero se pone en los MERGES, no en los commits."
        echo ""
        echo "Formato correcto para commits:"
        echo "  feat: descripci√≥n"
        echo "  fix: descripci√≥n"
        echo ""
        echo "Tu mensaje:"
        echo "  $commit_msg_no_comments"
        echo ""
        exit 1
    fi
    
    if echo "$commit_msg_no_comments" | grep -qiE "(close|fix|resolve)(s|d)? #"; then
        echo "‚ùå ERROR: Los commits NO deben usar 'Closes/Fixes/Resolves'."
        echo ""
        echo "El cierre de issues se hace en los MERGES, no en los commits."
        echo ""
        echo "Formato correcto para commits:"
        echo "  feat: descripci√≥n"
        echo "  fix: descripci√≥n"
        echo ""
        echo "Tu mensaje:"
        echo "  $commit_msg_no_comments"
        echo ""
        exit 1
    fi
fi

exit 0
