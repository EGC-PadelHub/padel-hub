name: Auto Assign, Add to Project and Label Priority

on:
  issues:
    types: [opened, edited]

jobs:
  manage-issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      repository-projects: write
    steps:
      - name: Manager (Assign, Project & Labels)
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body;
            if (!body) return;

            const assigneesRegex = /### Assignees\s*\n\s*([\s\S]*?)(?=\n###|$)/;
            const assigneesMatch = body.match(assigneesRegex);
            
            if (assigneesMatch && assigneesMatch[1]) {
              const rawAssignees = assigneesMatch[1].split(/[\n,]/).map(s => s.trim()).filter(s => s.length > 0);
              const ignore = ['None', '_No response_'];
              const validAssignees = rawAssignees.filter(a => !ignore.includes(a));

              if (validAssignees.length > 0) {
                try {
                  await github.rest.issues.addAssignees({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.issue.number,
                    assignees: validAssignees
                  });
                  console.log(`✅ Assigned to: ${validAssignees.join(', ')}`);
                } catch (e) { console.log(`❌ Error assigning users: ${e.message}`); }
              }
            }

            const PROJECT_NAME = "padel-hub Board"; 

            try {
              const projects = await github.rest.projects.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              const project = projects.data.find(p => p.name === PROJECT_NAME);
              if (project) {
                const columns = await github.rest.projects.listColumns({ project_id: project.id });
                if (columns.data.length > 0) {
                  try {
                    await github.rest.projects.createCard({
                      column_id: columns.data[0].id,
                      content_id: context.payload.issue.id,
                      content_type: 'Issue'
                    });
                    console.log(`✅ Added to project: ${PROJECT_NAME}`);
                  } catch (createError) { console.log(`ℹ️ Card note: ${createError.message}`); }
                }
              }
            } catch (e) { console.log(`❌ Error managing project: ${e.message}`); }

            // Busca la sección "### Priority" y lee lo que hay debajo
            const priorityRegex = /### Priority\s*\n\s*([^\n]*)/;
            const priorityMatch = body.match(priorityRegex);

            if (priorityMatch && priorityMatch[1]) {
              const selectedOption = priorityMatch[1].trim();
              let labelToAdd = '';

              // Detecta qué eligió el usuario (buscando palabras clave por si cambias los emojis)
              if (selectedOption.includes('High')) labelToAdd = 'priority: high';
              else if (selectedOption.includes('Medium')) labelToAdd = 'priority: medium';
              else if (selectedOption.includes('Low')) labelToAdd = 'priority: low';

              if (labelToAdd) {
                try {
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.issue.number,
                    labels: [labelToAdd]
                  });
                  console.log(`✅ Added label: ${labelToAdd}`);
                } catch (e) { console.log(`❌ Error adding label: ${e.message}`); }
              }
            }