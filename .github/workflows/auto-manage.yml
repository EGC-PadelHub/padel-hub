name: Auto Assign and Add to Project

on:
  issues:
    types: [opened, edited]

jobs:
  manage-issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      repository-projects: write
    steps:
      - name: Assign Users and Add to Project
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body;
            if (!body) return;

            // 1. ASSIGNEES (Multi-select)
            // Looks for: ### Assignees
            const assigneesRegex = /### Assignees\s*\n\s*([\s\S]*?)(?=\n###|$)/;
            const assigneesMatch = body.match(assigneesRegex);
            
            if (assigneesMatch && assigneesMatch[1]) {
              const rawAssignees = assigneesMatch[1].split(/[\n,]/).map(s => s.trim()).filter(s => s.length > 0);
              const ignore = ['None', '_No response_'];
              const validAssignees = rawAssignees.filter(a => !ignore.includes(a));

              if (validAssignees.length > 0) {
                try {
                  await github.rest.issues.addAssignees({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.issue.number,
                    assignees: validAssignees
                  });
                  console.log(`✅ Assigned to: ${validAssignees.join(', ')}`);
                } catch (e) { console.log(`❌ Error assigning users: ${e.message}`); }
              }
            }

            // 2. AUTO ADD TO PROJECT (Classic)
            // Define here the EXACT name of your project board
            const PROJECT_NAME = "padel-hub Board"; 

            try {
              // List repo projects
              const projects = await github.rest.projects.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              
              const project = projects.data.find(p => p.name === PROJECT_NAME);
              
              if (project) {
                // Get first column (e.g. "To Do")
                const columns = await github.rest.projects.listColumns({ project_id: project.id });
                if (columns.data.length > 0) {
                  try {
                    await github.rest.projects.createCard({
                      column_id: columns.data[0].id,
                      content_id: context.payload.issue.id,
                      content_type: 'Issue'
                    });
                    console.log(`✅ Added to project: ${PROJECT_NAME}`);
                  } catch (createError) {
                     console.log(`ℹ️ Card creation note: ${createError.message}`);
                  }
                }
              } else {
                console.log(`⚠️ Project "${PROJECT_NAME}" not found.`);
              }
            } catch (e) { console.log(`❌ Error managing project: ${e.message}`); }
