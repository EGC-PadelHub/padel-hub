{% extends "base_template.html" %}

{% block title %}Upload dataset{% endblock %}

{% block content %}

    <h1 class="h2 mb-3"><b>Upload</b> dataset</h1>

    <div class="row">
        <div class="col-12 mb-3">
            <div class="alert alert-warning" role="alert" id="test_zenodo_connection_error" style="display: none">
                <div class="alert-message">

                    <h4 class="alert-heading"><i class="align-middle" data-feather="alert-triangle"></i> Limited
                        connection to the Zenodo API</h4>
                    <p class="p-0 m-0">
                        There seems to be some kind of problem with the Zenodo API and synchronization of your dataset
                        files may not be possible. We will save your files locally to eventually synchronize them with
                        Zenodo. Sorry for the inconvenience, Zenodo is an external service and we can't do
                        anything about it.
                    </p>
                </div>
            </div>
        </div>

    </div>

    {% if messages %}
        <ul>
            {% for message in messages %}
                <li>{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}

    <div class="row">

        <div class="col-xl-6 col-lg-12 col-md-12 col-sm-12">
            <div id="basic_info_form">

                {{ form.hidden_tag() }}

                <div class="row">

                    <div class="col-12">

                        <h1 class="h3 mb-3">Basic info</h1>

                        <div class="row" style="padding-left: 2rem">

                            <div class="col-lg-6 col-xs-12 col-md-12">
                                <div class="mb-3">
                                    {{ form.title.label(class="form-label") }} *
                                    {{ form.title(class="form-control") }}
                                    {% for error in form.title.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="col-12">
                                <div class="mb-3">
                                    {{ form.desc.label(class="form-label") }} *
                                    {{ form.desc(rows=4, class="form-control") }}
                                    {% for error in form.desc.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="col-lg-6 col-6">
                                <div class="mb-3">
                                    {{ form.tournament_type.label(class="form-label") }}
                                    {{ form.tournament_type(class="form-select") }}
                                </div>

                            </div>

                            <div class="col-12 mt-2">
                                <h4 class="h5">Setup dataset type</h4>
                                <p class="text-muted">Choose how the dataset will be uploaded. You can upload it permanently to Zenodo, upload it anonymously (authors not exposed) or save as Draft locally.</p>
                                <div class="mb-3">
                                    <!-- Render radio choices for upload type -->
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="upload_type" id="upload_type_public" value="public" {% if not form.upload_type.data or form.upload_type.data == 'public' %}checked{% endif %}>
                                        <label class="form-check-label" for="upload_type_public">Permanent upload to Zenodo</label>
                                        <div class="text-muted small">Your dataset is ready to be uploaded to Zenodo permanently.</div>
                                    </div>
                                    <div class="form-check mt-2">
                                        <input class="form-check-input" type="radio" name="upload_type" id="upload_type_anonymous" value="anonymous" {% if form.upload_type.data == 'anonymous' %}checked{% endif %}>
                                        <label class="form-check-label" for="upload_type_anonymous">Permanent (anonymous) upload to Zenodo</label>
                                        <div class="text-muted small">Your dataset is ready to be uploaded to Zenodo permanently, but will remain anonymous (authors not published).</div>
                                    </div>
                                    <div class="form-check mt-2">
                                        <input class="form-check-input" type="radio" name="upload_type" id="upload_type_draft" value="draft" {% if form.upload_type.data == 'draft' %}checked{% endif %}>
                                        <label class="form-check-label" for="upload_type_draft">Draft</label>
                                        <div class="text-muted small">Save the dataset locally as draft; it won't be uploaded to Zenodo and won't be visible to the public yet.</div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-lg-6 col-6">
                                <div class="mb-3">
                                    {{ form.publication_doi.label(class="form-label") }}
                                    {{ form.publication_doi(class="form-control") }}
                                    {% for error in form.publication_doi.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="col-6">
                                <div class="mb-3">
                                    {{ form.tags.label(class="form-label") }}
                                    {{ form.tags(class="form-control") }}
                                    {% for error in form.tags.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                        </div>

                        <h1 class="h3 mb-3 mt-4">
                          Authors
                          <a href="#" data-toggle="modal" data-target="#infoModal">
                            <i data-feather="info"></i> <!-- Usamos "info" porque Feather no tiene un ícono específico llamado "feather" para más info -->
                          </a>
                        </h1>

                        <!-- Modal -->
                        <div class="modal fade" id="infoModal" tabindex="-1" role="dialog" aria-labelledby="infoModalLabel" aria-hidden="true" style="display: none">
                          <div class="modal-dialog" role="document">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h5 class="modal-title" id="infoModalLabel">Información Importante</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                  <span aria-hidden="true">&times;</span>
                                </button>
                              </div>
                              <div class="modal-body">
                                ¡Cuidado! Los autores no se pueden editar una vez que el dataset se haya subido a Padel‑Hub. Esta funcionalidad estará disponible para futuras versiones.
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                              </div>
                            </div>
                          </div>
                        </div>

                        <div class="row" style="padding-left: 2rem">

                            <div class="col-lg-6 col-12 mb-3">
                                <label class="form-label">Author name</label>
                                <input class="form-control"
                                       disabled
                                       value="{{ current_user.profile.surname }}, {{ current_user.profile.name }}">
                            </div>

                            <div class="col-lg-6 col-12 mb-3">
                                <label class="form-label">Author affiliation</label>
                                <input class="form-control"
                                       disabled value="{{ current_user.profile.affiliation }}">
                            </div>

                            <div class="col-lg-6 col-12 mb-3">
                                <label class="form-label">Author ORCID</label>
                                <input class="form-control"
                                       disabled value="{{ current_user.profile.orcid }}">
                            </div>

                            <div class="col-12">

                                <div class="mb-3">

                                    <div id="authors">
                                        {% for subform in form.authors %}
                                        <div class="row author" {% if not loop.first %}
                                            style="border:2px dotted #ccc;border-radius:10px;padding:10px;margin:10px 0; background-color: white"
                                            {% endif %}
                                        >
                                            <div class="col-lg-6 col-12 mb-3">
                                                {{ subform.form.name.label(class="form-label") }}
                                                {{ subform.form.name(class="form-control", disabled=loop.first) }}
                                                {% for error in subform.name.errors %}
                                                    <span style="color: red;">{{ error }}</span>
                                                {% endfor %}
                                            </div>

                                            <div class="col-lg-6 col-12 mb-3">
                                                {{ subform.form.affiliation.label(class="form-label") }}
                                                {{ subform.form.affiliation(class="form-control", disabled=loop.first) }}
                                                {% for error in subform.name.errors %}
                                                    <span style="color: red;">{{ error }}</span>
                                                {% endfor %}
                                            </div>

                                            <div class="col-lg-6 col-12 mb-3">
                                                {{ subform.orcid.label(class="form-label") }}
                                                {{ subform.orcid(class="form-control", disabled=loop.first) }}
                                                {% for error in subform.orcid.errors %}
                                                    <span style="color: red;">{{ error }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <button type="button" class="btn btn-secondary" id="add_author">Add author
                                    </button>

                                </div>

                            </div>


                        </div>

                    </div>

                </div>

                <div class="row">

                    {% if error %}

                        <div class="mt-3 col-lg-6 col-12">
                            <span style="color: red;">{{ error }}</span>
                        </div>

                    {% endif %}

                </div>


            </div>
        </div>

        <div class="col-xl-6 col-lg-12 col-md-12 col-sm-12">

            <h1 class="h3 mb-3 mt-2">CSV files (padel match datasets)</h1>

            <div id="uploaded_models_form" style="padding-left: 2rem">

                <form action="{{ url_for('dataset.upload') }}" class="dropzone" id="myDropzone">
                    <div id="dropzone-text"></div>
                </form>

                <span class="text-danger" id="alerts" style="display: none">
                    </span>

                <ul class="mt-2" id="file-list"></ul>

                <script>
                    let dropzone = Dropzone.options.myDropzone = {
                        url: "/dataset/file/upload",
                        paramName: 'file',
                        maxFilesize: 10,
                        acceptedFiles: '.csv',
                        init: function () {

                                // Ensure Dropzone appends a fresh CSRF token with each file upload.
                                // This reads the token at sending time (not page-load time) so it won't be stale.
                                this.on('sending', function(file, xhr, formData) {
                                    try {
                                        const csrfInput = document.querySelector('input[name="csrf_token"]');
                                        if (csrfInput && csrfInput.value) {
                                            formData.append('csrf_token', csrfInput.value);
                                        }
                                    } catch (e) {
                                        console.warn('Could not append CSRF token to Dropzone upload', e);
                                    }
                                });

                            let fileList = document.getElementById('file-list');
                            let dropzoneText = document.getElementById('dropzone-text');
                            let alerts = document.getElementById('alerts');

                            this.on('addedfile', function (file) {

                                let ext = file.name.split('.').pop().toLowerCase();
                                if (ext !== 'csv') {
                                    this.removeFile(file);

                                    let alert = document.createElement('p');
                                    alert.textContent = 'Invalid file extension: ' + file.name;
                                    alerts.appendChild(alert);
                                    alerts.style.display = 'block';
                                }

                            });

                            this.on('success', function (file, response) {

                                let dropzone = this;

                                show_upload_dataset();

                                console.log("File uploaded: ", response);
                                // actions when CSV file is uploaded
                                let listItem = document.createElement('li');
                                let h4Element = document.createElement('h4');
                                h4Element.textContent = response.filename;
                                listItem.appendChild(h4Element);

                                // generate incremental id for form
                                let formUniqueId = generateIncrementalId();

                                /*
                                    ##########################################
                                    FORM BUTTON
                                    ##########################################
                                */
                                let formButton = document.createElement('button');
                                formButton.innerHTML = 'Show info';
                                formButton.classList.add('info-button', 'btn', 'btn-outline-secondary', "btn-sm");
                                formButton.style.borderRadius = '5px';
                                formButton.id = formUniqueId + "_button";

                                formButton.addEventListener('click', function () {
                                    if (formContainer.style.display === "none") {
                                        formContainer.style.display = "block";
                                        formButton.innerHTML = 'Hide info';
                                    } else {
                                        formContainer.style.display = "none";
                                        formButton.innerHTML = 'Add info';
                                    }
                                });

                                // append space
                                let space = document.createTextNode(" ");
                                listItem.appendChild(space);

                                /*
                                    ##########################################
                                    REMOVE BUTTON
                                    ##########################################
                                */

                                // remove button
                                let removeButton = document.createElement('button');
                                removeButton.innerHTML = 'Delete model';
                                removeButton.classList.add("remove-button", "btn", "btn-outline-danger", "btn-sm", "remove-button");
                                removeButton.style.borderRadius = '5px';

                                // append space
                                space = document.createTextNode(" ");
                                listItem.appendChild(space);

                                removeButton.addEventListener('click', function () {
                                    fileList.removeChild(listItem);
                                    this.removeFile(file);

                                    // Ajax request
                                    let xhr = new XMLHttpRequest();
                                    xhr.open('POST', '/dataset/file/delete', true);
                                    xhr.setRequestHeader('Content-Type', 'application/json');
                                    xhr.onload = function () {
                                        if (xhr.status === 200) {
                                            console.log('Deleted file from server');

                                            if (dropzone.files.length === 0) {
                                                document.getElementById("upload_dataset").style.display = "none";
                                                clean_upload_errors();
                                            }

                                        }
                                    };
                                    xhr.send(JSON.stringify({file: file.name}));
                                }.bind(this));

                                /*
                                    ##########################################
                                    APPEND BUTTONS
                                    ##########################################
                                */
                                listItem.appendChild(formButton);
                                listItem.appendChild(removeButton);

                                /*
                                    ##########################################
                                        CSV FORM
                                        ##########################################
                                */

                                // create specific form for CSV
                                let formContainer = document.createElement('div');
                                formContainer.id = formUniqueId + "_form";
                                formContainer.classList.add('csv_form', "mt-3");
                                formContainer.style.display = "none";

                                formContainer.innerHTML = `
                                    <div class="row">
                                                        <input type="hidden" value="${response.filename}" name="files-${formUniqueId}-filename">
                                        <div class="col-12">
                                            <div class="row">
                                                <div class="col-12">
                                                    <div class="mb-3">
                                                        <label class="form-label">Title</label>
                                                        <input type="text" class="form-control" name="files-${formUniqueId}-title">
                                                    </div>
                                                </div>
                                                <div class="col-12">
                                                    <div class="mb-3">
                                                        <label class="form-label">Description</label>
                                                        <textarea rows="4" class="form-control" name="files-${formUniqueId}-desc"></textarea>
                                                    </div>
                                                </div>
                                                <div class="col-lg-6 col-12">
                                                    <div class="mb-3">
                                                        <label class="form-label" for="tournament_type">Padel Tournament Type</label>
                                                        <select class="form-select" name="files-${formUniqueId}-tournament_type">
                                                            <option value="">--</option>
                                                            <option value="master_final">Master Final</option>
                                                            <option value="master">Master</option>
                                                            <option value="open">Open</option>
                                                            <option value="qualifying">Qualifying</option>
                                                            <option value="national_tours">National Tours</option>
                                                            <option value="other">Other</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-lg-6 col-6">
                                                    <div class="mb-3">
                                                        <label class="form-label" for="publication_doi">Publication DOI</label>
                                                        <input class="form-control" name="files-${formUniqueId}-publication_doi" type="text" value="">
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">Tags (separated by commas)</label>
                                                        <input type="text" class="form-control" name="files-${formUniqueId}-tags">
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">CSV version</label>
                                                        <input type="text" class="form-control" name="files-${formUniqueId}-csv_version">
                                                    </div>
                                                </div>
                                                <div class="col-12">
                                                    <div class="mb-3">
                                                        <label class="form-label">Authors</label>
                                                        <div id="` + formContainer.id + `_authors">
                                                        </div>
                                                        <button type="button" class="add_author_to_csv btn btn-secondary" id="` + formContainer.id + `_authors_button">Add author</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    `;

                                listItem.appendChild(formContainer);
                                fileList.appendChild(listItem);

                            });

                                // Helper to show a simple modal with code snippet
                                function showCsvErrorModal(filename, line, message, snippet, snippet_start) {
                                    // remove existing modal if present
                                    const existing = document.getElementById('csvErrorModalOverlay');
                                    if (existing) existing.remove();

                                    const overlay = document.createElement('div');
                                    overlay.id = 'csvErrorModalOverlay';
                                    overlay.style.position = 'fixed';
                                    overlay.style.top = '0';
                                    overlay.style.left = '0';
                                    overlay.style.width = '100%';
                                    overlay.style.height = '100%';
                                    overlay.style.backgroundColor = 'rgba(0,0,0,0.5)';
                                    overlay.style.display = 'flex';
                                    overlay.style.alignItems = 'center';
                                    overlay.style.justifyContent = 'center';
                                    overlay.style.zIndex = '9999';

                                    const box = document.createElement('div');
                                    box.style.background = 'white';
                                    box.style.padding = '1rem';
                                    box.style.borderRadius = '6px';
                                    box.style.maxWidth = '900px';
                                    box.style.width = '90%';
                                    box.style.maxHeight = '80%';
                                    box.style.overflow = 'auto';

                                    const title = document.createElement('h4');
                                    title.textContent = `CSV syntax error in ${filename}`;
                                    box.appendChild(title);

                                    if (line) {
                                        const p = document.createElement('p');
                                        p.innerHTML = `<strong>Line:</strong> ${line}`;
                                        box.appendChild(p);
                                    }
                                    if (message) {
                                        const p = document.createElement('p');
                                        p.innerHTML = `<strong>Message:</strong> ${message}`;
                                        box.appendChild(p);
                                    }

                                    if (snippet) {
                                            // Create a monospace container and split lines to allow highlighting
                                            const container = document.createElement('div');
                                            container.style.background = '#f6f8fa';
                                            container.style.padding = '0.75rem';
                                            container.style.borderRadius = '4px';
                                            container.style.whiteSpace = 'pre';
                                            container.style.fontFamily = 'monospace';
                                            container.style.maxHeight = '50vh';
                                            container.style.overflow = 'auto';

                                            const lines = snippet.split(/\r?\n/);
                                            let startLine = null;
                                            if (typeof snippet_start !== 'undefined' && snippet_start !== null) {
                                                startLine = parseInt(snippet_start, 10);
                                            }

                                            // Determine which line to highlight. Prefer server-provided absolute `line`,
                                            // but fall back to a heuristic that finds the first line with an odd number
                                            // of double quotes (common sign of unbalanced quotes), and finally clamp
                                            // to a valid index if needed.
                                            let highlightedIdx = null;
                                            if (startLine !== null && typeof line !== 'undefined' && line !== null) {
                                                const errorIndex = parseInt(line, 10) - startLine;
                                                if (errorIndex >= 0 && errorIndex < lines.length) {
                                                    highlightedIdx = errorIndex;
                                                } else {
                                                    // heuristic: find line with odd number of double quotes
                                                    for (let h = 0; h < lines.length; h++) {
                                                        const cnt = (lines[h].match(/\"/g) || []).length;
                                                        if (cnt % 2 === 1) { highlightedIdx = h; break; }
                                                    }
                                                    // clamp to nearest line if heuristic didn't find anything
                                                    if (highlightedIdx === null) {
                                                        if (errorIndex < 0) highlightedIdx = 0;
                                                        else if (errorIndex >= lines.length) highlightedIdx = lines.length - 1;
                                                    }
                                                }
                                            } else {
                                                // No startLine or server line: try heuristic only
                                                for (let h = 0; h < lines.length; h++) {
                                                    const cnt = (lines[h].match(/\"/g) || []).length;
                                                    if (cnt % 2 === 1) { highlightedIdx = h; break; }
                                                }
                                            }

                                            lines.forEach(function(ln, idx) {
                                                const lineDiv = document.createElement('div');
                                                // show line numbers if startLine is provided
                                                let numSpan = null;
                                                if (startLine !== null) {
                                                    numSpan = document.createElement('span');
                                                    numSpan.textContent = (startLine + idx) + ' | ';
                                                    numSpan.style.color = '#666';
                                                    numSpan.style.display = 'inline-block';
                                                    numSpan.style.width = '4em';
                                                    lineDiv.appendChild(numSpan);
                                                }
                                                const textSpan = document.createElement('span');
                                                textSpan.textContent = ln;
                                                lineDiv.appendChild(textSpan);

                                                // Apply highlight if this line is the chosen one
                                                if (highlightedIdx !== null && idx === highlightedIdx) {
                                                    lineDiv.style.background = 'transparent';
                                                    lineDiv.style.fontWeight = '700';
                                                    const underlineColor = '#ff4d4f';
                                                    textSpan.style.textDecoration = 'underline';
                                                    textSpan.style.textDecorationColor = underlineColor;
                                                    textSpan.style.textDecorationThickness = '2px';
                                                    if (numSpan) {
                                                        numSpan.style.textDecoration = 'underline';
                                                        numSpan.style.textDecorationColor = underlineColor;
                                                        numSpan.style.textDecorationThickness = '2px';
                                                    }

                                                    // Add a small red 'Error' badge to the right of the line for extra visibility
                                                    const badge = document.createElement('span');
                                                    badge.textContent = 'Error';
                                                    badge.setAttribute('aria-hidden', 'true');
                                                    badge.style.background = underlineColor;
                                                    badge.style.color = '#ffffff';
                                                    badge.style.padding = '0.12rem 0.45rem';
                                                    badge.style.borderRadius = '4px';
                                                    badge.style.marginLeft = '0.6rem';
                                                    badge.style.fontSize = '0.78em';
                                                    badge.style.fontWeight = '700';
                                                    badge.style.display = 'inline-block';
                                                    badge.style.verticalAlign = 'middle';
                                                    lineDiv.appendChild(badge);
                                                }

                                                container.appendChild(lineDiv);
                                            });

                                            box.appendChild(container);
                                        }

                                    const close = document.createElement('button');
                                    close.className = 'btn btn-primary mt-3';
                                    close.textContent = 'Close';
                                    close.addEventListener('click', function () { overlay.remove(); });
                                    box.appendChild(close);

                                    overlay.appendChild(box);
                                    document.body.appendChild(overlay);
                                }

                                // Helper to show a modal with structure validation errors (padel format)
                                function showStructureErrorModal(filename, errors, csvContent) {
                                    // remove existing modal if present
                                    const existing = document.getElementById('csvErrorModalOverlay');
                                    if (existing) existing.remove();

                                    const overlay = document.createElement('div');
                                    overlay.id = 'csvErrorModalOverlay';
                                    overlay.style.position = 'fixed';
                                    overlay.style.top = '0';
                                    overlay.style.left = '0';
                                    overlay.style.width = '100%';
                                    overlay.style.height = '100%';
                                    overlay.style.backgroundColor = 'rgba(0,0,0,0.5)';
                                    overlay.style.display = 'flex';
                                    overlay.style.alignItems = 'center';
                                    overlay.style.justifyContent = 'center';
                                    overlay.style.zIndex = '9999';

                                    const box = document.createElement('div');
                                    box.style.background = 'white';
                                    box.style.padding = '1.5rem';
                                    box.style.borderRadius = '6px';
                                    box.style.maxWidth = '1000px';
                                    box.style.width = '95%';
                                    box.style.maxHeight = '85%';
                                    box.style.overflow = 'auto';

                                    const title = document.createElement('h4');
                                    title.textContent = `CSV Validation Error: ${filename}`;
                                    title.style.color = '#d32f2f';
                                    title.style.marginBottom = '1rem';
                                    box.appendChild(title);

                                    // Error summary section
                                    const errorSummary = document.createElement('div');
                                    errorSummary.style.marginBottom = '1rem';
                                    errorSummary.style.padding = '0.75rem';
                                    errorSummary.style.background = '#fff3cd';
                                    errorSummary.style.border = '1px solid #ffc107';
                                    errorSummary.style.borderRadius = '4px';
                                    
                                    const summaryTitle = document.createElement('strong');
                                    summaryTitle.textContent = `Found ${errors.length} validation error${errors.length > 1 ? 's' : ''}:`;
                                    summaryTitle.style.display = 'block';
                                    summaryTitle.style.marginBottom = '0.5rem';
                                    errorSummary.appendChild(summaryTitle);
                                    
                                    const errorList = document.createElement('ul');
                                    errorList.style.margin = '0';
                                    errorList.style.paddingLeft = '1.5rem';
                                    errors.forEach(function(err) {
                                        const li = document.createElement('li');
                                        li.textContent = err;
                                        li.style.marginBottom = '0.25rem';
                                        errorList.appendChild(li);
                                    });
                                    errorSummary.appendChild(errorList);
                                    box.appendChild(errorSummary);

                                    // CSV preview section with highlighted errors
                                    if (csvContent) {
                                        const previewTitle = document.createElement('h5');
                                        previewTitle.textContent = 'CSV Preview (errors highlighted):';
                                        previewTitle.style.marginTop = '1rem';
                                        previewTitle.style.marginBottom = '0.5rem';
                                        box.appendChild(previewTitle);

                                        const csvContainer = document.createElement('div');
                                        csvContainer.style.background = '#f6f8fa';
                                        csvContainer.style.padding = '0.75rem';
                                        csvContainer.style.borderRadius = '4px';
                                        csvContainer.style.fontFamily = 'monospace';
                                        csvContainer.style.fontSize = '0.85rem';
                                        csvContainer.style.overflow = 'auto';
                                        csvContainer.style.maxHeight = '400px';
                                        csvContainer.style.border = '1px solid #ddd';

                                        // Extract error line numbers from error messages
                                        const errorLines = new Set();
                                        errors.forEach(function(err) {
                                            const match = err.match(/Row (\d+):/);
                                            if (match) {
                                                errorLines.add(parseInt(match[1]));
                                            }
                                        });

                                        const lines = csvContent.split('\n');
                                        lines.forEach(function(line, idx) {
                                            const lineNumber = idx + 1; // 1-indexed
                                            const lineDiv = document.createElement('div');
                                            lineDiv.style.padding = '2px 4px';
                                            lineDiv.style.whiteSpace = 'pre';
                                            
                                            // Line number
                                            const numSpan = document.createElement('span');
                                            numSpan.textContent = lineNumber.toString().padStart(3, ' ') + ' | ';
                                            numSpan.style.color = '#666';
                                            numSpan.style.userSelect = 'none';
                                            lineDiv.appendChild(numSpan);
                                            
                                            // Line content
                                            const contentSpan = document.createElement('span');
                                            contentSpan.textContent = line;
                                            
                                            // Highlight error lines
                                            if (errorLines.has(lineNumber)) {
                                                lineDiv.style.background = '#ffebee';
                                                lineDiv.style.borderLeft = '3px solid #d32f2f';
                                                lineDiv.style.paddingLeft = '8px';
                                                contentSpan.style.color = '#d32f2f';
                                                contentSpan.style.fontWeight = 'bold';
                                                
                                                // Add error badge
                                                const badge = document.createElement('span');
                                                badge.textContent = ' ⚠ ERROR';
                                                badge.style.background = '#d32f2f';
                                                badge.style.color = 'white';
                                                badge.style.padding = '0.1rem 0.4rem';
                                                badge.style.borderRadius = '3px';
                                                badge.style.fontSize = '0.75rem';
                                                badge.style.marginLeft = '0.5rem';
                                                badge.style.fontWeight = 'bold';
                                                contentSpan.appendChild(badge);
                                            }
                                            
                                            lineDiv.appendChild(contentSpan);
                                            csvContainer.appendChild(lineDiv);
                                        });

                                        box.appendChild(csvContainer);
                                    }

                                    const close = document.createElement('button');
                                    close.className = 'btn btn-primary mt-3';
                                    close.textContent = 'Close';
                                    close.addEventListener('click', function () { overlay.remove(); });
                                    box.appendChild(close);

                                    overlay.appendChild(box);
                                    document.body.appendChild(overlay);
                                }

                                this.on('error', function (file, response) {
                                console.error("Error uploading file: ", response);
                                // response may be a string or an object
                                let errorMsg = 'CSV not valid: ' + file.name;
                                let snippet = null;
                                let line = null;
                                let data = null;
                                
                                if (response) {
                                    try {
                                        // If server returned JSON, Dropzone passes the parsed object
                                        data = response;
                                        if (typeof response === 'string') {
                                            try { data = JSON.parse(response); } catch (e) { data = { message: response }; }
                                        }
                                        if (data.error) {
                                            errorMsg = `CSV not valid: ${file.name} — ${data.error}`;
                                        } else if (data.message) {
                                            errorMsg = `CSV not valid: ${file.name} — ${data.message}`;
                                        }
                                        if (data.line) line = data.line;
                                        if (data.snippet) snippet = data.snippet;
                                    } catch (e) {
                                        console.warn('Could not parse error response', e);
                                    }
                                }
                                
                                // Remove the file preview from Dropzone so the user can re-add a corrected file.
                                try {
                                    if (this && typeof this.removeFile === 'function') {
                                        this.removeFile(file);
                                    }
                                } catch (e) {
                                    console.warn('Could not remove file preview from Dropzone', e);
                                }

                                // Check if we have structure validation errors (padel format)
                                if (data && data.errors && Array.isArray(data.errors) && data.errors.length > 0) {
                                    // Structure validation errors - read file content and show in modal
                                    const reader = new FileReader();
                                    reader.onload = function(e) {
                                        const csvContent = e.target.result;
                                        showStructureErrorModal(file.name, data.errors, csvContent);
                                    };
                                    reader.onerror = function() {
                                        // Fallback if file reading fails
                                        showStructureErrorModal(file.name, data.errors, null);
                                    };
                                    reader.readAsText(file);
                                    return;
                                }

                                // show modal with snippet if available (syntax errors)
                                let snippet_start = null;
                                if (response && typeof response === 'object' && response.snippet_start) {
                                    snippet_start = response.snippet_start;
                                } else if (data && data.snippet_start) {
                                    snippet_start = data.snippet_start;
                                }

                                if (snippet) {
                                    showCsvErrorModal(file.name, line, errorMsg, snippet, snippet_start);
                                } else if (!data || !data.errors) {
                                    // Fallback: show a simple alert if no structured errors or snippet
                                    alert(errorMsg);
                                }
                            });

                        }
                    };


                </script>

            </div>
        </div>

    </div>

    <div class="row" id="upload_dataset" style="display: none">

        <div class="col-12">

            <hr>

            <h1 class="h3 mb-3 mt-2">Upload dataset</h1>

            <div style="padding-left: 2rem">

                <label class="form-check">
                    <input id="agreeCheckbox" class="form-check-input" type="checkbox" value="">
                    <span class="form-check-label" style="font-size: 15px">
                                I agree to have my datasets automatically uploaded to Zenodo and made available to the public according to the <a
                            href="https://en.wikipedia.org/wiki/Open_science" target="_blank">Open Science</a> manifesto
                            </span>
                </label>

                <button id="upload_button" class="btn btn-primary mt-2" disabled>
                    <i data-feather="upload" class="center-button-icon"></i>
                    Upload dataset</button>

                <div id="loading" style="display: none">
                    <img width="40px" src="{{ url_for("static", filename="gifs/loading.svg") }}"/>
                    Uploading dataset, please wait...
                </div>

                <div class="row">
                    <div class="col-12 mb-3">

                    </div>
                </div>

                <div class="alert alert-error" role="alert" id="upload_error"
                     style="display: none">
                    <div class="alert-message">

                        <h4 class="alert-heading"><i class="align-middle" data-feather="alert-triangle"></i> Limited
                            connection to the Zenodo API</h4>
                        <p class="p-0 m-0">
                            There seems to be some kind of problem with the Zenodo API and synchronization of your
                            dataset
                            files may not be possible. We will save your files locally to eventually synchronize
                            them with
                            Zenodo. Sorry for the inconvenience, Zenodo is an external service and we can't do
                            anything about it.
                        </p>
                    </div>
                </div>


                <span class="text-danger mt-2" id="upload_error" style="display: none">

                    </span>

                <script>
                    const checkbox = document.getElementById('agreeCheckbox');
                    const upload_button = document.getElementById('upload_button');

                    checkbox.addEventListener('change', function () {
                        upload_button.disabled = !checkbox.checked;
                    });
                </script>

            </div>




        </div>

    </div>


{% endblock %}

{% block scripts %}
    <script src="{{ url_for('dataset.scripts') }}"></script>
{% endblock %}